<html>
    <head>
        <TITLE>Covid19</TITLE>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    </head>
    <body>
        <canvas id="timelineCases"></canvas>
        <canvas id="barChartCases"></canvas>
    </body>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-160266365-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-160266365-1');
    </script>
</html>
<script>

dataUrl = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"

d3.csv(dataUrl).then(makeChart);

function makeChart(rawData)
{
    let countriesOfInterest = ["Estonia", "Latvia", "Lithuania"]; // can hardcode
    let countriesFilteredOut = ["Mainland China", "US", "Others"]; // todo: handle (summarize?)
    let minAmountOfCases = 100;
    let datesLabels = dateLabels(rawData[0]);

    let data = rawData.filter(function(x) {
        if (countriesFilteredOut.includes(x["Country/Region"])) return false;
        if (countriesOfInterest.includes(x["Country/Region"])) return true;
        return getMaxAmount(x, datesLabels) >= minAmountOfCases;
    });
    console.log(data);
    let [year, month, day] = yesterdaysDate();
    let dateUSA = usaDate(year, month, day);
    let dateISO = isoDate(year, month, day);
    
    var labels = data.map(x => x["Country/Region"]);
    var volume = data.map(x => x[dateUSA]);

    var chart = new Chart('timelineCases', {
        type: 'line',
        data: {
            labels: datesLabels,
            datasets: [{
                label: data[0]["Country/Region"],
                data: valuesPerDates(data[0], datesLabels)
            }]
        },
        options: {}
    });

    new Chart('barChartCases', {
        type: 'horizontalBar',
        data: {
            labels: labels,
            datasets: [
                {
                    data: volume
                }
            ]
        },
        options: {
            legend: {
                display: false,
            },
            title: {
                display: true,
                text: 'Infected on ' + dateISO,
            }
        }
    });

    // new Chart('timelineCases', {
    //     type: 'horizontalBar',
    //     data: {
    //         labels: labels,
    //         datasets: [
    //             {
    //                 data: volume
    //             }
    //         ]
    //     },
    //     options: {
    //         legend: {
    //             display: false,
    //         },
    //         title: {
    //             display: true,
    //             text: 'Infected',
    //         }
    //     }
    // });

}
function dateLabels(jsonObj){
    let nonDateProperties = ["Province/State","Country/Region","Lat","Long"];
    let dateProperties = [];
    for (var property in jsonObj) {
        if(nonDateProperties.includes(property)) continue;
        dateProperties.push(property);
    }
    return dateProperties;  
}

let valuesPerDates = (countryRecord, datesLabels) => datesLabels.map(x => countryRecord[x]);

let getMaxAmount = (countryRecord, datesLabels) => Math.max(...valuesPerDates(countryRecord, datesLabels));

function yesterdaysDate(){
    var date = new Date();
    date.setDate(date.getDate() - 1);
    var year = date.getFullYear().toString().substr(-2);
    var month = date.getMonth() + 1; //js months are zero-based
    var day = date.getDate();
    return [year, month, day]
}

let usaDate = (year, month, day) => month + '/' + day + '/' + year;
let isoDate = (year, month, day) => '20' + year + '/' + month + '/' + day;

</script>